image: "python:$PYTHON_TAG"

variables:
  PYTHON_TAG: 3.14.2-slim-trixie

stages:
  - building
  - testing

deps:
  stage: building
  tags:
    - formation
  variables:
    TRIGGER_CACHE: "off"
  script:
    - python -m venv venv
    - source venv/bin/activate
    - pip install -r app/requirements.txt
  cache:
    key: "py-deps-$CI_COMMIT_BRANCH"
    paths:
      - venv/
    policy: push
  rules:
    - changes:
        - app/requirements.txt
    - if: $TRIGGER_CACHE == "on"
     
test:
  stage: testing
  tags:
    - formation
  before_script:
    - source venv/bin/activate
  script:
    - pytest --junitxml=reports/junit.xml
  # files or directories generated by the script
  # to be saved
  artifacts:
    # en cas de succès et d'échec des tests
    when: always
    # niveau de rôle suffisant pour accéder aux artefacts
    access: all
    expire_in: "1 hour"
    # mise à disposition des artefacts en téléchargement dans l'interface GitLab
    # injecte les artefacts dans les jobs suivants
    paths:
      - reports/junit.xml
  cache:
    key: "py-deps-$CI_COMMIT_BRANCH"
    untracked: true
    policy: pull